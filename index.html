<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ğŸº å•†å“æ‹ç…§å‘½ååŠ©æ‰‹ - åŸºäº AI çš„ç”µå•†é‡å‘½åä¸è¯æœ¯ç”Ÿæˆå·¥å…·ã€‚æ”¯æŒä¸€é”®è¯†åˆ«åŠ ZIP æ‰“åŒ…ã€‚">
    <meta name="keywords" content="AI, ç”µå•†, å•†å“å‘½å, ç›´æ’­è¯æœ¯, è‡ªåŠ¨é‡å‘½å">
    <title>ğŸº å•†å“æ‹ç…§å‘½ååŠ©æ‰‹ v2.0 - æ‚¨çš„ AI æ™ºèƒ½ä»“åº“ç®¡ç†å‘˜</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --accent-color: #667eea;
            --success-color: #52c41a;
            --text-dark: #2d3436;
            --text-light: #636e72;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-dark);
        }

        .main-wrapper {
            flex: 1;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 60px 40px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 38px;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .header p {
            opacity: 0.85;
            font-size: 16px;
            font-weight: 300;
            max-width: 600px;
            margin: 0 auto;
        }

        .btn-toggle-config {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .btn-toggle-config:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .config-panel {
            background: #f8f9fa;
            border-bottom: 2px solid #667eea;
            padding: 30px;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .config-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #764ba2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-item {
            margin-bottom: 20px;
            max-width: 600px;
        }

        .config-item label {
            display: block;
            font-size: 14px;
            color: #444;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .config-item input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .content {
            padding: 40px;
        }

        .step {
            margin-bottom: 50px;
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .step-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            margin-right: 12px;
            font-size: 16px;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .upload-box {
            border: 2px dashed #ccd0d5;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fdfdfd;
            height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: #f7f9ff;
            transform: translateY(-2px);
        }

        .upload-box.has-image {
            border-color: #52c41a;
            background: #f6ffed;
        }

        .upload-icon {
            font-size: 44px;
            margin-bottom: 12px;
            filter: grayscale(1);
            opacity: 0.6;
        }

        .upload-label {
            font-weight: 600;
            color: #444;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .upload-hint {
            font-size: 13px;
            color: #999;
        }

        .upload-preview {
            width: 100%;
            height: 140px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .status-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #52c41a;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .ai-section {
            background: #f9faff;
            border: 2px solid #e1e4ff;
            border-radius: 12px;
            padding: 40px;
        }

        .ai-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .ai-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .ai-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-result {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid #eee;
        }

        .ai-result-label {
            font-size: 15px;
            font-weight: 600;
            color: #555;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .name-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 18px;
            transition: all 0.3s;
            color: #333;
            font-weight: 500;
        }

        .name-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .live-script-box {
            background: #fffef6;
            border: 1px solid #ffe58f;
            border-radius: 10px;
            padding: 24px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-size: 15px;
            line-height: 1.8;
            color: #614d0c;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }

        .copy-btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #40a9ff;
        }

        .id-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .id-prefix {
            font-size: 22px;
            font-weight: 700;
            color: #333;
        }

        .id-input {
            width: 120px;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 20px;
            text-align: center;
            font-weight: 700;
            color: #667eea;
        }

        .preview-section {
            background: #f8f9fb;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #edf0f2;
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            color: #555;
            margin-bottom: 20px;
        }

        .preview-item {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            color: #333;
            border-left: 5px solid #52c41a;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            display: flex;
            align-items: center;
        }

        .preview-item::before {
            content: "ğŸ“„";
            margin-right: 12px;
        }

        .download-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .download-btn {
            padding: 16px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .download-btn.primary {
            background: #52c41a;
            color: white;
            box-shadow: 0 4px 10px rgba(82, 196, 26, 0.2);
        }

        .download-btn.primary:hover:not(:disabled) {
            background: #73d13d;
            transform: translateY(-2px);
        }

        .download-btn.secondary {
            background: #f0f2f5;
            color: #5c6b77;
        }

        .download-btn.secondary:hover {
            background: #e6e9ed;
        }

        .loading {
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hint {
            background: #fffbe6;
            border-left: 4px solid #faad14;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            color: #856404;
            margin-top: 15px;
        }

        .help-btn {
            position: absolute;
            top: 40px;
            right: 40px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #preview-list {
            list-style: none;
        }

        .browser-warning {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            color: #ff4d4f;
            font-size: 14px;
            line-height: 1.6;
            display: none;
            border-left: 5px solid #ff4d4f;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<body>
    <div class="main-wrapper">
        <div class="container">
            <div class="header">
                <button type="button" class="help-btn" onclick="showHelp()">?</button>
                <h1>ğŸº å•†å“æ‹ç…§å‘½ååŠ©æ‰‹ v2.0</h1>
                <p>AIæ™ºèƒ½è¯†åˆ«ï¼Œä¸€é”®ç”Ÿæˆé‡å‘½åæ–¹æ¡ˆä¸ç›´æ’­è„šæœ¬</p>
                <button type="button" class="btn-toggle-config" onclick="toggleConfig()">âš™ï¸ API é…ç½®</button>
            </div>

            <div id="config-panel" class="config-panel">
                <div class="config-title">
                    <span>ç«å±±æ–¹èˆŸï¼ˆè±†åŒ…ï¼‰API é…ç½®</span>
                    <button type="button" onclick="toggleConfig()"
                        style="border:none;background:none;cursor:pointer;font-size:24px;">âœ•</button>
                </div>
                <div class="config-item">
                    <label>API Key</label>
                    <input type="password" id="api-key" placeholder="ä¾‹å¦‚: a6edf06c-xxxx-xxxx">
                </div>
                <div class="config-item">
                    <label>æ¨¡å‹åç§° / æ¥å…¥ç‚¹ ID</label>
                    <input type="text" id="endpoint-id" placeholder="ä¾‹å¦‚: ep-20260228213630-fqk5p">
                </div>
                <p style="font-size: 13px; color: #666; line-height: 1.5;">ğŸ’¡
                    <b>é…ç½®è¯´æ˜ï¼š</b> è¿™é‡Œçš„ API Key æ˜¯æ–¹èˆŸç®¡ç†é¡µé¢ç”Ÿæˆçš„ UUID å­—ç¬¦ä¸²ã€‚æ¨¡å‹åç§°å¯ä»¥å¡«ç§å­æ¨¡å‹åæˆ–æ¨ç†æ¥å…¥ç‚¹ IDã€‚
                </p>
            </div>

            <div class="content">
                <div class="step">
                    <div class="step-title"><span class="step-number">1</span>ä¸Šä¼ å•†å“ç…§ç‰‡ï¼ˆ5å¼ ï¼‰</div>
                    <div class="upload-grid">
                        <div class="upload-box" id="box-0" onclick="document.getElementById('file-0').click()">
                            <input type="file" id="file-0" accept="image/*"
                                onchange="handleFileSelect(0, this.files[0])">
                            <div class="upload-icon">ğŸ“¸</div>
                            <div class="upload-label">æ­£é¢</div>
                            <div class="upload-hint">ç‚¹å‡»ä¸Šä¼ </div>
                        </div>
                        <div class="upload-box" id="box-1" onclick="document.getElementById('file-1').click()">
                            <input type="file" id="file-1" accept="image/*"
                                onchange="handleFileSelect(1, this.files[0])">
                            <div class="upload-icon">ğŸ“¸</div>
                            <div class="upload-label">èƒŒé¢</div>
                            <div class="upload-hint">ç‚¹å‡»ä¸Šä¼ </div>
                        </div>
                        <div class="upload-box" id="box-2" onclick="document.getElementById('file-2').click()">
                            <input type="file" id="file-2" accept="image/*"
                                onchange="handleFileSelect(2, this.files[0])">
                            <div class="upload-icon">ğŸ“¸</div>
                            <div class="upload-label">åº•éƒ¨</div>
                            <div class="upload-hint">ç‚¹å‡»ä¸Šä¼ </div>
                        </div>
                        <div class="upload-box" id="box-3" onclick="document.getElementById('file-3').click()">
                            <input type="file" id="file-3" accept="image/*"
                                onchange="handleFileSelect(3, this.files[0])">
                            <div class="upload-icon">ğŸ“¸</div>
                            <div class="upload-label">å…‹é‡</div>
                            <div class="upload-hint">ç‚¹å‡»ä¸Šä¼ </div>
                        </div>
                        <div class="upload-box" id="box-4" onclick="document.getElementById('file-4').click()">
                            <input type="file" id="file-4" accept="image/*"
                                onchange="handleFileSelect(4, this.files[0])">
                            <div class="upload-icon">ğŸ“¸</div>
                            <div class="upload-label">é•¿åº¦</div>
                            <div class="upload-hint">ç‚¹å‡»ä¸Šä¼ </div>
                        </div>
                    </div>
                    <div class="hint">ğŸ’¡ æç¤ºï¼šAI å°†ä¼˜å…ˆåˆ†æã€Œæ­£é¢ã€èƒŒé¢ã€åº•éƒ¨ã€ä¸‰å¼ å›¾</div>
                </div>

                <div class="step">
                    <div class="step-title"><span class="step-number">2</span>AI æ™ºèƒ½è¯†åˆ«</div>
                    <div class="ai-section">
                        <div id="browser-warning" class="browser-warning"></div>
                        <button type="button" class="ai-button" id="ai-btn" onclick="recognizeProduct()" disabled>
                            <span id="ai-btn-text">ğŸ¤– AI æ™ºèƒ½è¯†åˆ«</span>
                        </button>
                        <div style="text-align: center; margin-top: 12px;">
                            <a href="javascript:void(0)" onclick="recognizeProduct(true)"
                                style="color: #667eea; font-size: 13px; text-decoration: none;">ğŸ’¡
                                ç¯å¢ƒå—é™ï¼Ÿç‚¹æ­¤å°è¯•ã€æ¨¡æ‹Ÿè¯†åˆ«æ¼”ç¤ºã€‘æµ‹è¯•ä¸‹è½½æµç¨‹</a>
                        </div>
                        <div id="ai-result" class="ai-result" style="display: none;">
                            <div class="ai-result-label">ğŸ’¡ AI å»ºè®®åç§°ï¼š</div>
                            <input type="text" id="product-name" class="name-input" oninput="updatePreview()">
                            <div class="ai-result-label" style="margin-top: 30px;">
                                <span>ğŸ“œ ä¸“ä¸šç›´æ’­è¯æœ¯ï¼ˆåˆè§„ç‰ˆï¼‰ï¼š</span>
                                <button type="button" class="copy-btn" onclick="copyScript()">ğŸ“‹ å¤åˆ¶è¯æœ¯</button>
                            </div>
                            <div id="live-script" class="live-script-box">è¯†åˆ«ä¸­...</div>
                        </div>
                    </div>
                </div>

                <div class="step">
                    <div class="step-title"><span class="step-number">3</span>è¾“å…¥ç¼–å·</div>
                    <div class="id-input-group">
                        <span class="id-prefix">LF</span>
                        <input type="text" id="product-id" class="id-input" placeholder="001" maxlength="3"
                            oninput="handleIdInput(this)" onchange="updatePreview()">
                    </div>
                </div>

                <div class="step">
                    <div class="step-title"><span class="step-number">4</span>æ‰“åŒ…ä¸‹è½½</div>
                    <div class="preview-section">
                        <div class="preview-title">âœ… é‡å‘½åé¢„è§ˆï¼š</div>
                        <ul id="preview-list">
                            <li class="preview-item" style="border:none;box-shadow:none;color:#999;">è¯·å…ˆè¯†åˆ«...</li>
                        </ul>
                    </div>
                    <div class="download-section">
                        <button type="button" class="download-btn primary" id="download-all-btn" onclick="downloadAll()"
                            disabled>ğŸ“¦
                            æ‰“åŒ…ä¸‹è½½
                            ZIP (å›¾ç‰‡ + è¯æœ¯)</button>
                        <button type="button" class="download-btn secondary" onclick="resetForm()">ğŸ”„ ç»§ç»­å¤„ç†ä¸‹ä¸€ä»¶</button>
                    </div>
                </div>
            </div>

            <footer style="text-align: center; padding: 40px 20px; color: var(--text-light); font-size: 14px;">
                <p>Â© 2026 Franco Yixuan Â· <a href="https://github.com/YixuanFranco"
                        style="color: var(--accent-color); text-decoration: none;">GitHub</a></p>
                <p style="margin-top: 8px; opacity: 0.7;">ğŸº AI powered by Doubao Â· Built with Passion</p>
            </footer>
        </div>

        <script>
            const state = {
                files: [null, null, null, null, null],
                labels: ['æ­£é¢', 'èƒŒé¢', 'åº•éƒ¨', 'å…‹é‡', 'é•¿åº¦'],
                productName: '',
                productId: '001',
                lastId: 0,
                liveScript: ''
            };

            function init() {
                const savedId = localStorage.getItem('lastProductId');
                if (savedId) { state.lastId = parseInt(savedId); }
                const nextId = (state.lastId + 1).toString().padStart(3, '0');
                document.getElementById('product-id').value = nextId;
                state.productId = nextId;

                // åŠ è½½å·²ä¿å­˜çš„é…ç½®
                const savedKey = localStorage.getItem('doubao_api_key');
                const savedEid = localStorage.getItem('doubao_endpoint_id');
                if (savedKey) document.getElementById('api-key').value = savedKey;
                if (savedEid) document.getElementById('endpoint-id').value = savedEid;

                // ç¯å¢ƒæ£€æŸ¥
                if (location.protocol === 'file:') {
                    const warning = document.getElementById('browser-warning');
                    warning.innerHTML = 'âš ï¸ <b>æœ¬åœ°è¿è¡Œæç¤ºï¼š</b> å¦‚æœè¯†åˆ«æŠ¥é”™ï¼Œè¯·ç¡®ä¿å¼€å¯äº† CORS è·¨åŸŸæ’ä»¶ï¼ˆå˜ä¸ºçº¢è‰²å›¾æ ‡ï¼‰ã€‚';
                    warning.style.display = 'block';
                }
            }

            function toggleConfig() {
                const panel = document.getElementById('config-panel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            }

            function handleFileSelect(index, file) {
                if (!file) return;
                state.files[index] = file;
                const box = document.getElementById(`box-${index}`);
                box.classList.add('has-image');
                const reader = new FileReader();
                reader.onload = (e) => {
                    box.innerHTML = `<input type="file" id="file-${index}" accept="image/*" onchange="handleFileSelect(${index}, this.files[0])">
                    <img src="${e.target.result}" class="upload-preview">
                    <div class="upload-label">${state.labels[index]}</div>
                    <div class="status-badge">âœ“</div>`;
                };
                reader.readAsDataURL(file);
                checkAIButtonState();
            }

            function checkAIButtonState() {
                document.getElementById('ai-btn').disabled = !(state.files[0] && state.files[1] && state.files[2]);
            }

            async function recognizeProduct(isDemo = false) {
                const btn = document.getElementById('ai-btn');
                const btnText = document.getElementById('ai-btn-text');
                const apiKey = document.getElementById('api-key').value.trim();
                const eid = document.getElementById('endpoint-id').value.trim();

                if (!isDemo && (!apiKey || !eid)) {
                    alert('è¯·å…ˆè¾“å…¥ API Key å’Œ æ¨ç†æ¥å…¥ç‚¹ ID (ä»¥ ep- å¼€å¤´)');
                    toggleConfig();
                    return;
                }

                btn.disabled = true;
                btnText.innerHTML = '<div class="loading"></div> ' + (isDemo ? 'æ¨¡æ‹Ÿå¤„ç†ä¸­...' : 'AI æ™ºèƒ½è¯†åˆ«ä¸­...');

                try {
                    let result;
                    if (isDemo) {
                        await new Promise(r => setTimeout(r, 1200));
                        result = {
                            productName: 'è€ç™½é“œéé‡‘ç»¿åº¦æ¯åƒ',
                            liveScript: "ã€å¼€åœºç›´å‡»ã€‘ï¼šå„ä½è—å‹ï¼Œçœ‹çœ‹è¿™çš®å£³ï¼ŒåŒ…æµ†æµ‘åšï¼Œ typical è—å®¶è‡ªè—è´§ï¼\n\nã€ç»†èŠ‚é‰´èµã€‘ï¼šå¼€è„¸åº„ä¸¥ï¼Œçº¿æ¡æµç•…ï¼Œåº•æ¬¾æ¸…æ™°ï¼Œå¤§å¼€é—¨çš„ä¸œè¥¿ã€‚\n\nã€æ–‡è„‰ä»·å€¼ã€‘ï¼šç»¿åº¦æ¯è±¡å¾æ…ˆæ‚²ï¼Œå·¥è‰ºç²¾æ¹›ï¼Œæ˜¯ä¸å¯é”™è¿‡çš„æ”¶è—ä½³å“ã€‚\n\nã€å‚¬å•é—­ç¯ã€‘ï¼šå’±ä»¬è—å®¶äº¤æµï¼Œæ”¯æŒ7å¤©æ— ç†ç”±é€€æ¢ï¼Œç»“ç¼˜ä»·èµ°ä¸€ä¸ªï¼"
                        };
                    } else {
                        const imgs = await Promise.all([fileToBase64(state.files[0]), fileToBase64(state.files[1]), fileToBase64(state.files[2])]);
                        result = await callDoubaoAPI(imgs);
                    }
                    document.getElementById('ai-result').style.display = 'block';
                    document.getElementById('product-name').value = result.productName;
                    document.getElementById('live-script').textContent = result.liveScript;
                    state.productName = result.productName;
                    state.liveScript = result.liveScript;
                    updatePreview();
                    btnText.textContent = isDemo ? 'âœ“ æ¼”ç¤ºå®Œæˆ' : 'âœ“ è¯†åˆ«å®Œæˆ';
                    setTimeout(() => { btnText.textContent = 'ğŸ¤– AI æ™ºèƒ½è¯†åˆ«'; btn.disabled = false; }, 2000);
                } catch (e) {
                    console.error("è¯†åˆ«é”™è¯¯:", e);
                    if (e.message === 'Failed to fetch') {
                        if (confirm('è¯†åˆ«å¤±è´¥ï¼šæµè§ˆå™¨è·¨åŸŸå®‰å…¨æ‹¦æˆª (CORS)\n\nå»ºè®®è§£å†³æ–¹æ³•ï¼š\n1. å®‰è£… [Allow CORS] æ’ä»¶\n2. å¼€å¯æ’ä»¶å¼€å…³ï¼ˆçº¢è‰²å›¾æ ‡ï¼‰ååˆ·æ–°é‡è¯•\n\næ˜¯å¦ä½¿ç”¨ã€æ¨¡æ‹Ÿæ¨¡å¼ã€‘é¢„è§ˆæ•ˆæœï¼Ÿ')) {
                            recognizeProduct(true);
                            return;
                        }
                    } else {
                        alert('è¯†åˆ«å¤±è´¥: ' + e.message);
                    }
                    btn.disabled = false;
                    btnText.textContent = 'âŒ é‡è¯•';
                }
            }

            async function callDoubaoAPI(images) {
                const apiKey = document.getElementById('api-key').value.trim();
                const model = document.getElementById('endpoint-id').value.trim();

                localStorage.setItem('doubao_api_key', apiKey);
                localStorage.setItem('doubao_endpoint_id', model);

                const prompt = `ä½ æ˜¯ä¸€ä½é¡¶çº§çš„é‰´èµä¸“å®¶å’Œä¸»æ’­ã€‚è¯·è¯†åˆ«è¿™ä¸‰å¼ å›¾ç‰‡ï¼ˆæ­£é¢ã€èƒŒé¢ã€åº•éƒ¨ï¼‰ã€‚
            1. å•†å“å‘½åï¼ˆæè´¨+é¢˜æ+ç±»å‹ï¼Œè¦æ±‚ç²¾ç‚¼ï¼Œä¸è¶…è¿‡15å­—ï¼‰ã€‚
            2. ç”Ÿæˆç›´æ’­è¯æœ¯ï¼ˆå£è¯­åŒ–ï¼ŒåŒ…å«ç»†èŠ‚é‰´èµã€æ–‡è„‰æè¿°ã€åˆè§„çš„å¼•å¯¼è¯æœ¯ï¼Œå¿…é¡»æåŠ"æ”¯æŒ7å¤©æ— ç†ç”±é€€æ¢"ï¼‰ã€‚
            è¯·ä¸¥æ ¼æŒ‰ç…§ JSON è¿”å›ï¼š{"productName": "...", "liveScript": "..."}`;

                // æ„å»ºç¬¦åˆæ‚¨æä¾›çš„å®˜æ–¹ç¤ºä¾‹çš„ /v3/responses ç»“æ„
                const payload = {
                    model: model,
                    input: [
                        {
                            role: "user",
                            content: [
                                {
                                    type: "input_text",
                                    text: prompt
                                },
                                ...images.map(img => ({
                                    type: "input_image",
                                    image_url: `data:image/jpeg;base64,${img}`
                                }))
                            ]
                        }
                    ]
                };

                const resp = await fetch('https://ark.cn-beijing.volces.com/api/v3/responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    if (resp.status === 401 || resp.status === 403) {
                        throw new Error("è®¤è¯å¤±è´¥ï¼šAPI Key æˆ– æ¨¡å‹åç§°æœ‰è¯¯ã€‚");
                    }
                    throw new Error(err.error?.message || `API è¯·æ±‚å¤±è´¥ (${resp.status})`);
                }

                const data = await resp.json();
                console.log("æœåŠ¡å™¨è¿”å›åŸå§‹æ•°æ®:", data);

                // ä¸‡èƒ½è§£æå™¨ï¼šé€’å½’å¯»æ‰¾ä»»ä½•åŒ…å«æœ‰æ•ˆå¯¹è¯å†…å®¹çš„å­—ç¬¦ä¸²
                function extractContent(obj) {
                    if (!obj || typeof obj !== 'object') return null;

                    // ä¼˜å…ˆçº§ 1: å®˜æ–¹æ¨èè·¯å¾„
                    const standard = obj.choices?.[0]?.message?.content || obj.output?.message?.content;
                    if (typeof standard === 'string' && standard.length > 0) return standard;
                    if (Array.isArray(standard)) {
                        const textPart = standard.find(p => p.type === 'text' || p.text);
                        if (textPart) return textPart.text || textPart.content;
                    }

                    // ä¼˜å…ˆçº§ 2: æ·±åº¦éå†æ¢æµ‹
                    for (const key in obj) {
                        const value = obj[key];
                        if (typeof value === 'string' && (key === 'content' || key === 'text') && value.length > 10) {
                            return value;
                        }
                        if (value && typeof value === 'object') {
                            const result = extractContent(value);
                            if (result) return result;
                        }
                    }
                    return null;
                }

                const content = extractContent(data);

                if (!content) {
                    console.error("æœªèƒ½è§£æç»“æœç»“æ„:", data);
                    throw new Error("AI å“åº”æˆåŠŸä½†æœªæ‰¾åˆ°æ–‡æœ¬ã€‚ç»“æ„å·²æ‰“å°åœ¨æ§åˆ¶å°ï¼Œè¯·æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ”¯æŒè§†è§‰è¯†åˆ«ã€‚");
                }

                try {
                    const cleanJson = content.replace(/```json\n?|\n?```/g, '').trim();
                    const parsed = JSON.parse(cleanJson);
                    state.liveScript = parsed.liveScript || content;
                    return parsed;
                } catch (e) {
                    state.liveScript = content;
                    return {
                        productName: "è¯†åˆ«æˆåŠŸ",
                        liveScript: content
                    };
                }
            }

            function fileToBase64(f) {
                return new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result.split(',')[1]);
                    r.onerror = rej;
                    r.readAsDataURL(f);
                });
            }

            function handleIdInput(i) {
                i.value = i.value.replace(/\D/g, '').slice(-3);
                state.productId = i.value.padStart(3, '0');
            }

            function updatePreview() {
                const name = document.getElementById('product-name').value.trim();
                const id = document.getElementById('product-id').value.padStart(3, '0');
                const list = document.getElementById('preview-list');
                let html = '';
                state.files.forEach((f, idx) => {
                    if (f) {
                        const ext = f.name.split('.').pop();
                        html += `<li class="preview-item">LF${id}-${name}-${state.labels[idx]}.${ext}</li>`;
                    }
                });
                list.innerHTML = html || '<li class="preview-item">è¯·å…ˆè¯†åˆ«...</li>';
                document.getElementById('download-all-btn').disabled = !name || !state.files[0];
            }

            function copyScript() {
                navigator.clipboard.writeText(state.liveScript).then(() => {
                    const b = document.querySelector('.copy-btn');
                    b.textContent = 'âœ“ å·²å¤åˆ¶';
                    setTimeout(() => b.textContent = 'ğŸ“‹ å¤åˆ¶è¯æœ¯', 2000);
                });
            }

            async function downloadAll() {
                if (typeof JSZip === 'undefined') {
                    alert('JSZip åº“å°šæœªåŠ è½½å®Œæˆï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢ã€‚');
                    return;
                }

                const rawName = document.getElementById('product-name').value || 'æœªå‘½åå•†å“';
                const name = rawName.replace(/[\\/:*?"<>|]/g, '_').trim();
                const id = document.getElementById('product-id').value.padStart(3, '0');
                const btn = document.getElementById('download-all-btn');

                btn.disabled = true;
                btn.innerHTML = '<div class="loading"></div> æ‰“åŒ…ä¸­...';

                try {
                    const zip = new JSZip();
                    const folderName = `LF${id}-${name}`;
                    const folder = zip.folder(folderName);

                    let hasFiles = false;
                    for (let i = 0; i < state.files.length; i++) {
                        if (state.files[i]) {
                            const ext = state.files[i].name.split('.').pop() || 'jpg';
                            const fileName = `LF${id}-${name}-${state.labels[i]}.${ext}`;
                            folder.file(fileName, await state.files[i].arrayBuffer());
                            hasFiles = true;
                        }
                    }

                    if (!hasFiles) {
                        alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡åå†ä¸‹è½½ï¼');
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸ“¦ æ‰“åŒ…ä¸‹è½½ ZIP (å›¾ç‰‡ + è¯æœ¯)';
                        return;
                    }

                    if (state.liveScript) {
                        folder.file(`LF${id}-${name}-ç›´æ’­è¯æœ¯.txt`, state.liveScript);
                    }

                    const content = await zip.generateAsync({ type: "blob" });
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `${folderName}.zip`;
                    document.body.appendChild(a);
                    a.click();

                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 200);

                    localStorage.setItem('lastProductId', id);
                    alert('ä¸‹è½½å·²å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨ä¸‹è½½è®°å½•ã€‚');
                } catch (e) {
                    console.error("æ‰“åŒ…é”™è¯¯:", e);
                    alert('æ‰“åŒ…ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚');
                } finally {
                    btn.innerHTML = 'ğŸ“¦ æ‰“åŒ…ä¸‹è½½ ZIP (å›¾ç‰‡ + è¯æœ¯)';
                    btn.disabled = false;
                }
            }

            function resetForm() {
                if (confirm('ç¡®è®¤æ¸…ç©ºï¼Ÿ')) location.reload();
            }

            function showHelp() {
                alert("v2.0 ç»ˆæç‰ˆï¼š\n- åŸºäº AI çš„å•†å“æ™ºèƒ½å‘½å\n- è‡ªåŠ¨ç”Ÿæˆåˆè§„ç›´æ’­è¯æœ¯\n- è‡ªåŠ¨ç¼–å·ä¸ ZIP æ‰¹é‡ä¸‹è½½\n- é€‚é… GitHub Pages åœ¨çº¿è¿è¡Œ");
            }

            window.onload = init;
        </script>
</body>

</html>